---
title: HA集群工作方式一种实现思路
date: 2018-04-07 20:21:48
tags: [负载均衡, 高可用，冗余备份]
categories: 杂七杂八
---
HA是High Available缩写，是双机集群系统简称，指高可用性集群，是保证业务连续性的有效解决方案，一般有两个或两个以上的节点，且分为活动节点及备用节点。
一般HA集群是有两台设备互为备份，但是还有一种多台服务器一起工作互为备份的情况。各为服务定义一个或多个备用主机，当某个主机故障时，运行在其上的服务就可以被其它主机接管。服务器之间要各自监控其他服务器的状态，当有服务挂起或者重新加入，要能及时更新服务器的状态表。下面是一种实现方案

<!-- more -->

前提：集群中的设备之间能两两互联。
原则: 

1. 启动之后先向其它节点发送hello消息，更新配置
2. HELLO消息的用途:向其它节点发送自己的配置信息;用来向某台节点查询其它节点的状态。
3. ALIVED消息，用来查询别的节点是否存活
4. 删除节点的时候，保证所有节点都在正常运行


### 节点工作流程
+ 节点新启动
  + 读取配置文件设备列表，向列表中的设备发送HELLO消息（对方收到消息后回复当前集群设备列表）。进入到运行状态

+ 节点运行状态
  + 收到HELLO消息
    + 回复所有节点的消息
  
+ 收到ALIVED包信息
  + 告知对方自己存活


+ 定时向列表中的设备发送ALIVED包，查询其是否存活
  + 如果(多次)没收到回复判断对方没有存活，如果没有存活，按照策略进行下一步操作，更新设备信息 

### 示例
1. 新部署一个节点A,配置文件中什么也没有，bind一个端口等待其它设备的消息。
2. 又部署一个节点B,配置文件中什么也没有，bind一个端口等待其它设备的消息。
3. 在A机上把B拉入到集群当中，（A往B发ADD消息，AB互相感知到对方，各自更新设备列表，添加彼此的信息）。
4. AB互相发ALIVED消息，检测对方是否存活
5. A节点把C节点拉入到集群当中，（向C发送ADD消息，并向B发送ADD C的消息，ABC各自更新设备列表，添加彼此的信息）
6. ABC互相发ALIVED消息，检测对方是否存活
7. A把D拉入到集群当中，同C


